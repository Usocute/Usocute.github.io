{
    "version": "https://jsonfeed.org/version/1",
    "title": "脆弱星球 • All posts by \"存储过程\" tag",
    "description": "立于皓月之边,不弱星光之势",
    "home_page_url": "https://eliauk.cc",
    "items": [
        {
            "id": "https://eliauk.cc/post/47c80ad2.html",
            "url": "https://eliauk.cc/post/47c80ad2.html",
            "title": "MySQL 存储过程事务处理",
            "date_published": "2020-09-19T02:24:11.000Z",
            "content_html": "<h2 id=\"存储过程\"><a href=\"#存储过程\" class=\"headerlink\" title=\"存储过程\"></a>存储过程</h2><h3 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h3><p>存储程序是被存储在服务器中的组合SQL语句，经编译创建并保存在数据库中，用户可通过存储过程的名字调用执行。存储过程核心思想就是数据库SQL语言层面的封装与重用性。使用存储过程可以较少应用系统的业务复杂性，但是会增加数据库服务器系统的负荷。</p>\n<h3 id=\"基本语法\"><a href=\"#基本语法\" class=\"headerlink\" title=\"基本语法\"></a>基本语法</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">PROCEDURE</span> sp_name ([proc_parameter[,...]])</span><br><span class=\"line\">    [characteristic ...] routine_body</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"案例\"><a href=\"#案例\" class=\"headerlink\" title=\"案例\"></a>案例</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 查询学生表中性别为男的学生总数</span></span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">PROCEDURE</span> u_pro(<span class=\"keyword\">IN</span> v_sex <span class=\"built_in\">VARCHAR</span>(<span class=\"number\">5</span>) <span class=\"built_in\">CHARACTER</span> <span class=\"keyword\">SET</span> utf8 ,<span class=\"keyword\">OUT</span> <span class=\"keyword\">num</span> <span class=\"built_in\">INT</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">\t<span class=\"keyword\">SELECT</span> <span class=\"keyword\">COUNT</span>(*) <span class=\"keyword\">INTO</span> <span class=\"keyword\">num</span> <span class=\"keyword\">FROM</span> student <span class=\"keyword\">WHERE</span> v_sex=sex;</span><br><span class=\"line\">  <span class=\"keyword\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CALL</span> u_pro(<span class=\"string\">&#x27;男&#x27;</span>,@<span class=\"keyword\">num</span>);</span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> @<span class=\"keyword\">num</span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 计算1+到n的值</span></span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">PROCEDURE</span> addresult(<span class=\"keyword\">IN</span> n <span class=\"built_in\">INT</span>)</span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">\t<span class=\"keyword\">DECLARE</span> i <span class=\"built_in\">INT</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">DECLARE</span> <span class=\"keyword\">sum</span> <span class=\"built_in\">INT</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">SET</span> <span class=\"keyword\">sum</span> =<span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">SET</span> i =<span class=\"number\">1</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tWHILE i&lt;n DO</span><br><span class=\"line\">\t<span class=\"keyword\">SET</span> <span class=\"keyword\">sum</span>=<span class=\"keyword\">sum</span>+i;</span><br><span class=\"line\">\t<span class=\"keyword\">SET</span> i=i+<span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">END</span> <span class=\"keyword\">WHILE</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">SELECT</span> <span class=\"keyword\">sum</span> ;</span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">call</span> addresult(<span class=\"number\">50</span>);</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 计算1+到n的值</span></span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">PROCEDURE</span> addresult2(<span class=\"keyword\">in</span> n <span class=\"built_in\">INT</span>,<span class=\"keyword\">out</span> <span class=\"keyword\">sum</span> <span class=\"built_in\">INT</span>)</span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">\t<span class=\"keyword\">DECLARE</span> i <span class=\"built_in\">INT</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">DECLARE</span> <span class=\"keyword\">sum</span> <span class=\"built_in\">INT</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">SET</span> <span class=\"keyword\">sum</span> =<span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">SET</span> i =<span class=\"number\">1</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tWHILE i&lt;n DO</span><br><span class=\"line\">\t<span class=\"keyword\">SET</span> <span class=\"keyword\">sum</span>=<span class=\"keyword\">sum</span>+i;</span><br><span class=\"line\">\t<span class=\"keyword\">SET</span> i=i+<span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">END</span> <span class=\"keyword\">WHILE</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">SELECT</span> <span class=\"keyword\">sum</span> ;</span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">call</span> addresult2(<span class=\"number\">50</span>,@<span class=\"keyword\">sum</span>);</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 判断变量</span></span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">PROCEDURE</span> user_main_pro3(INOUT v_id <span class=\"built_in\">INT</span>)</span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">  <span class=\"comment\"># 定义变量</span></span><br><span class=\"line\">  <span class=\"keyword\">DECLARE</span> v_count <span class=\"built_in\">INT</span>(<span class=\"number\">11</span>);</span><br><span class=\"line\">  <span class=\"comment\"># 判断</span></span><br><span class=\"line\">  IF v_id &gt; 3 THEN</span><br><span class=\"line\">     <span class=\"keyword\">SET</span> v_count = <span class=\"number\">100</span>;</span><br><span class=\"line\">  ELSE </span><br><span class=\"line\">     <span class=\"keyword\">SET</span> v_count = <span class=\"number\">500</span>;</span><br><span class=\"line\">  <span class=\"keyword\">END</span> <span class=\"keyword\">IF</span>;</span><br><span class=\"line\">  <span class=\"comment\"># 返回赋值</span></span><br><span class=\"line\">  <span class=\"keyword\">SET</span> v_id = v_count;</span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SET</span> @v_id=<span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">call</span> user_main_pro3(@v_id);</span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> @v_id;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"事务处理\"><a href=\"#事务处理\" class=\"headerlink\" title=\"事务处理\"></a>事务处理</h2><h3 id=\"注意点\"><a href=\"#注意点\" class=\"headerlink\" title=\"注意点\"></a>注意点</h3><p><strong>MySQL中Innodb支持事务，而MyISAM不支持事务</strong></p>\n<h3 id=\"事务的特性：\"><a href=\"#事务的特性：\" class=\"headerlink\" title=\"事务的特性：\"></a>事务的特性：</h3><ul>\n<li>原子性（Atomicity）：事务开始后的所有操作，要么全部做完，要么全部不做。事务执行过程中出错，会回滚到事务开始前的状态，所有的操作就像没有发生一样。</li>\n<li>一致性（Consistency）：事务开始前和结束后，数据库的完整性约束没有被破坏 。比如A向B转账，不可能A扣了钱，B却没收到。</li>\n<li>隔离性（Isolation）：同一时间，只允许一个事务请求同一数据，不同的事务之间彼此没有任何干扰。比如A正在从一张银行卡中取钱，在A取钱的过程结束前，B不能向这张卡转账。</li>\n<li>持久性（Durability）：事务完成后，事务对数据库的所有更新将被保存到数据库，不能回滚。</li>\n</ul>\n<h3 id=\"并发问题\"><a href=\"#并发问题\" class=\"headerlink\" title=\"并发问题\"></a>并发问题</h3><ul>\n<li><p>脏读：事务A读取了事务B更新的数据，然后B回滚操作，那么A读取到的数据是脏数据</p>\n</li>\n<li><p>不可重复读：事务 A 多次读取同一数据，事务 B 在事务A多次读取的过程中，对数据作了更新并提交，导致事务A多次读取同一数据时，结果 不一致。</p>\n</li>\n<li><p>幻读：系统管理员A将数据库中所有学生的成绩从具体分数改为ABCDE等级，但是系统管理员B就在这个时候插入了一条具体分数的记录，当系统管理员A改结束后发现还有一条记录没有改过来，就好像发生了幻觉一样，这时就叫幻读。</p>\n</li>\n</ul>\n<p><strong>注:不可重复读的和幻读很容易混淆，不可重复读侧重于修改，幻读侧重于新增或删除。解决不可重复读的问题只需锁住满足条件的行，解决幻读需要锁表</strong></p>\n<h3 id=\"事务隔离级别\"><a href=\"#事务隔离级别\" class=\"headerlink\" title=\"事务隔离级别\"></a>事务隔离级别</h3><table>\n<thead>\n<tr>\n<th align=\"left\">事务隔离级别</th>\n<th align=\"right\">脏读</th>\n<th align=\"center\">不可重复读</th>\n<th align=\"center\">幻读</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">读未提交（read-uncommitted）</td>\n<td align=\"right\">是</td>\n<td align=\"center\">是</td>\n<td align=\"center\">是</td>\n</tr>\n<tr>\n<td align=\"left\">不可重复读（read-committed）</td>\n<td align=\"right\">否</td>\n<td align=\"center\">是</td>\n<td align=\"center\">是</td>\n</tr>\n<tr>\n<td align=\"left\">可重复读（repeatable-read）</td>\n<td align=\"right\">否</td>\n<td align=\"center\">否</td>\n<td align=\"center\">是</td>\n</tr>\n<tr>\n<td align=\"left\">串行化（serializable）</td>\n<td align=\"right\">否</td>\n<td align=\"center\">否</td>\n<td align=\"center\">否</td>\n</tr>\n</tbody></table>\n<p><strong>设置隔离级别：</strong> </p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SET</span> <span class=\"keyword\">SESSION</span> <span class=\"keyword\">TRANSACTION</span> <span class=\"keyword\">ISOLATION</span> <span class=\"keyword\">LEVEL</span> <span class=\"keyword\">READ</span> UNCOMMITTED;</span><br></pre></td></tr></table></figure>\n\n<p>只有增删改语句才支持事务</p>\n",
            "tags": [
                "MySQL",
                "数据库",
                "存储过程",
                "视图"
            ]
        }
    ]
}